(function(){"use strict";var B=(t=>(t.IDLE="IDLE",t.TRAINING="TRAINING",t.TRAINING_RANDOM="TRAINING_RANDOM",t.TRAINING_SELF="TRAINING_SELF",t.PVP="PVP",t))(B||{});const b=8,P=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]],U=()=>{const t=Array(b).fill(null).map(()=>Array(b).fill(null)),e=b/2;return t[e-1][e-1]="White",t[e][e]="White",t[e-1][e]="Black",t[e][e-1]="Black",t};var D=Object.freeze({__proto__:null,applyMove:(t,e,n,r)=>{if(n<0||n>=b||r<0||r>=b)return t;const o=t.map(s=>[...s]);o[n][r]=e;for(const[s,a]of P){let _=n+s,c=r+a;const g=[];for(;_>=0&&_<b&&c>=0&&c<b;){const I=o[_][c];if(I===null)break;if(I!==e)g.push({row:_,col:c});else{g.length>0&&g.forEach(p=>{o[p.row][p.col]=e});break}_+=s,c+=a}}return o},countScore:t=>{let e=0,n=0;return t.flat().forEach(r=>{r==="Black"&&e++,r==="White"&&n++}),{Black:e,White:n}},createInitialBoard:U});let i;function x(t,e){return t=t>>>0,L().subarray(t/4,t/4+e)}function z(t,e){return t=t>>>0,F().subarray(t/1,t/1+e)}function G(t,e){return t=t>>>0,J(t,e)}let d=null;function L(){return(d===null||d.byteLength===0)&&(d=new Uint32Array(i.memory.buffer)),d}let y=null;function F(){return(y===null||y.byteLength===0)&&(y=new Uint8Array(i.memory.buffer)),y}function C(t,e){const n=e(t.length*4,4)>>>0;return L().set(t,n/4),k=t.length,n}let v=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});v.decode();const j=2146435072;let R=0;function J(t,e){return R+=e,R>=j&&(v=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),v.decode(),R=e),v.decode(F().subarray(t,t+e))}let k=0;const M=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>i.__wbg_bitboard_free(t>>>0,1));class u{static __wrap(e){e=e>>>0;const n=Object.create(u.prototype);return n.__wbg_ptr=e,M.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,M.unregister(this),e}free(){const e=this.__destroy_into_raw();i.__wbg_bitboard_free(e,0)}constructor(){const e=i.bitboard_new();return this.__wbg_ptr=e>>>0,M.register(this,this.__wbg_ptr,this),this}static create(e,n){const r=i.bitboard_create(e,n);return u.__wrap(r)}get_black(){const e=i.bitboard_get_black(this.__wbg_ptr);return BigInt.asUintN(64,e)}get_white(){const e=i.bitboard_get_white(this.__wbg_ptr);return BigInt.asUintN(64,e)}count_disks(){const e=i.bitboard_count_disks(this.__wbg_ptr);var n=x(e[0],e[1]).slice();return i.__wbindgen_free(e[0],e[1]*4,4),n}apply_move(e,n){const r=i.bitboard_apply_move(this.__wbg_ptr,e,n);return u.__wrap(r)}get_valid_moves_mask(e){const n=i.bitboard_get_valid_moves_mask(this.__wbg_ptr,e);return BigInt.asUintN(64,n)}get_valid_moves_indices(e){const n=i.bitboard_get_valid_moves_indices(this.__wbg_ptr,e);var r=z(n[0],n[1]).slice();return i.__wbindgen_free(n[0],n[1]*1,1),r}evaluate(e,n){const r=C(n,i.__wbindgen_malloc),o=k;return i.bitboard_evaluate(this.__wbg_ptr,e,r,o)}get_best_move(e,n,r){const o=C(r,i.__wbindgen_malloc),s=k;return i.bitboard_get_best_move(this.__wbg_ptr,e,n,o,s)}}Symbol.dispose&&(u.prototype[Symbol.dispose]=u.prototype.free);const V=new Set(["basic","cors","default"]);async function X(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.ok&&V.has(t.type)&&t.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function q(){const t={};return t.wbg={},t.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(e,n){throw new Error(G(e,n))},t.wbg.__wbindgen_init_externref_table=function(){const e=i.__wbindgen_externrefs,n=e.grow(4);e.set(0,void 0),e.set(n+0,void 0),e.set(n+1,null),e.set(n+2,!0),e.set(n+3,!1)},t}function Y(t,e){return i=t.exports,N.__wbindgen_wasm_module=e,d=null,y=null,i.__wbindgen_start(),i}async function N(t){if(i!==void 0)return i;typeof t<"u"&&(Object.getPrototypeOf(t)===Object.prototype?{module_or_path:t}=t:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof t>"u"&&(t=new URL("/assets/neuroreversi_engine_bg-BLSniIKw.wasm",self.location.href));const e=q();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await X(await t,e);return Y(n,r)}let E=!1;const K=t=>{let e=0n,n=0n;for(let r=0;r<8;r++)for(let o=0;o<8;o++){const s=t[r][o];s==="Black"?e|=1n<<BigInt(r*8+o):s==="White"&&(n|=1n<<BigInt(r*8+o))}return u.create(e,n)};self.onmessage=async t=>{const{type:e,mode:n,brain:r,reportUpdates:o}=t.data;if(e!=="START_GAME")return;if(!E)try{await N(),E=!0}catch(m){console.warn("Standard init failed, trying explicit path",m);try{await N("/neuroreversi_engine_bg.wasm"),E=!0}catch(A){console.error("CRITICAL: Failed to load WASM in Worker",A);return}}let s=U(),a="Black";const _=[];let c,g=0;const I=200;let p=0;for(;g<I;){const m=K(s),A=a==="Black",S=m.get_valid_moves_indices(A);if(S.length===0){if(c++,c>=2)break;a=a==="Black"?"White":"Black";continue}c=0;let w;if(a==="Black"){let f=new Int32Array(64);if(r&&r.weights)for(let l=0;l<64;l++)f[l]=Math.floor(r.weights[l]);w=m.get_best_move(6,A,f)}else if(n===B.TRAINING_RANDOM){const f=Math.floor(Math.random()*S.length);w=S[f]}else if(n===B.TRAINING_SELF){let O=new Int32Array(64);if(r&&r.weights)for(let l=0;l<64;l++)O[l]=Math.floor(r.weights[l]);w=m.get_best_move(4,A,O)}else w=S[0];const W={row:Math.floor(w/8),col:w%8};_.push({board:JSON.parse(JSON.stringify(s)),move:W,color:a});const{applyMove:H,countScore:Q}=await Promise.resolve().then(function(){return D});if(s=H(s,a,W.row,W.col),o){const f=Date.now();f-p>50&&(p=f,self.postMessage({type:"GAME_UPDATE",board:s,scores:Q(s)}))}a=a==="Black"?"White":"Black",g++}const{countScore:Z}=await Promise.resolve().then(function(){return D}),h=Z(s);let T=null;h.Black>h.White?T="Black":h.White>h.Black&&(T="White"),self.postMessage({type:"GAME_OVER",history:_,winner:T,scores:h,finalBoard:s})}})();
